<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Intelligence | V48 Final Persistence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #f8f9fc; --accent: #007aff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #1c1c1e; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        #ton-connect-button button { background: #000 !important; border-radius: 14px !important; }
        .nav-btn { opacity: 0.3; transition: 0.3s; filter: grayscale(1); }
        .nav-active { opacity: 1; filter: grayscale(0); transform: scale(1.15); }
        .led-glow { box-shadow: 0 0 12px currentColor; }
        #terminal-logs { height: 85px; display: flex; flex-direction: column; justify-content: flex-end; overflow: hidden; line-height: 1.6; }
        .royal-card { background: linear-gradient(135deg, #fff9e6 0%, #fff 100%); border: 2px solid #fbbf24; }
        .terminal-grey { background-color: #e5e7eb !important; border-top: 2px solid #3b82f6 !important; }
        .btn-correct { background-color: #22c55e !important; color: white !important; border-color: #16a34a !important; }
        .btn-wrong { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
    </style>
</head>
<body class="pb-32">

    <nav class="fixed top-0 w-full z-50 glass px-5 py-4 flex justify-between items-center rounded-none bg-white border-b border-gray-100">
        <div class="flex items-center gap-3">
            <div class="bg-black p-2 rounded-xl shadow-lg">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="white"/>
                    <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2"/>
                    <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2"/>
                </svg>
            </div>
            <div class="leading-none">
                <span class="text-xl font-black tracking-tighter uppercase">Nexus</span>
                <span class="text-[10px] block font-bold text-blue-600 tracking-[0.2em] mono uppercase">Intelligence</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="flex items-center gap-1.5 bg-gray-50 px-3 py-2 rounded-full border border-gray-100">
                <div id="led-dot" class="w-2 h-2 rounded-full bg-red-500 led-glow"></div>
                <span id="led-text" class="text-[9px] font-black uppercase mono text-gray-400">Offline</span>
            </div>
            <div id="ton-connect-button"></div>
        </div>
    </nav>

    <main id="tab-pilot" class="tab-content active pt-28 px-5 max-w-md mx-auto">
        <div class="flex justify-between items-center mb-5 px-1">
            <span id="os-text" class="text-[10px] font-extrabold text-gray-400 mono italic uppercase tracking-widest">Awaiting Node...</span>
            <span class="text-[10px] font-black text-blue-500 mono uppercase bg-blue-50 px-2 py-0.5 rounded">Alpha v4.8</span>
        </div>
        
        <div class="glass p-7 mb-6 bg-white border-b-4 border-blue-600">
            <div class="border-b border-gray-100 pb-5 mb-5">
                <p class="text-[10px] font-black text-blue-600 mb-1 uppercase tracking-[0.15em]">Pre-Sale Balance ($NI)</p>
                <h2 class="text-5xl font-black tracking-tighter" id="tokenBal">0.00</h2>
            </div>
            <div>
                <p class="text-[10px] font-black text-gray-400 mb-1 uppercase tracking-[0.15em]">Neural Points (NXP)</p>
                <h2 class="text-3xl font-bold text-gray-800 tracking-tight" id="pointBal">0.00</h2>
            </div>
        </div>

        <div class="terminal-grey rounded-2xl p-5 mb-6 shadow-2xl overflow-hidden border-t-2">
            <div id="terminal-logs" class="mono text-[10px] text-blue-700 font-bold"><div>> SYSTEM STANDBY...</div></div>
        </div>

        <div class="glass p-6 mb-6 bg-white border border-gray-100">
            <div class="flex justify-between items-end mb-3">
                <span class="text-[10px] font-black text-black uppercase italic tracking-wider">12H Neural Node Mining</span>
                <span class="text-xs font-black text-blue-600 mono" id="mineProgText">0 / 50 NXP</span>
            </div>
            <div class="w-full bg-gray-100 h-4 rounded-full overflow-hidden mb-5 border border-gray-200 shadow-inner">
                <div id="mineBar" class="h-full bg-blue-600 w-0 transition-all duration-1000"></div>
            </div>
            <button id="mineBtn" onclick="toggleMining()" class="w-full bg-[#1c1c1e] text-white py-5 rounded-2xl font-black text-xs uppercase shadow-xl hover:scale-[1.02] active:scale-95 transition-all">Start Neural Session</button>
            <p id="timer-text" class="text-center mt-4 text-[10px] font-bold text-gray-400 mono uppercase tracking-widest">Awaiting Command</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="glass p-4 flex flex-col items-center bg-white"><p class="text-[9px] font-black text-gray-400 uppercase mb-1">Test Success</p><p class="text-xl font-black text-blue-600" id="uiSuccess">0%</p></div>
            <div class="glass p-4 flex flex-col items-center bg-white"><p class="text-[9px] font-black text-gray-400 uppercase mb-1">Multiplier</p><p class="text-xl font-black text-green-600" id="uiMult">x1.00</p></div>
        </div>
    </main>

    <main id="tab-tasks" class="tab-content pt-28 px-5 max-w-md mx-auto">
        <div id="task-intro" class="glass p-12 text-center bg-white mb-6 border-2 border-blue-100">
            <div class="text-5xl mb-6">üß†</div>
            <h2 class="text-xl font-black mb-2 uppercase tracking-tight">Neural Optimization</h2>
            <p class="text-[10px] text-gray-400 font-black mb-10 italic uppercase tracking-tighter">Validate 10 Packets (0.5 NXP Per Correct)</p>
            <button onclick="startTraining()" class="w-full bg-black text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg">Begin Batch</button>
        </div>

        <div id="task-area" class="hidden mb-6">
            <div class="flex justify-between items-center mb-4"><span class="text-[10px] font-black text-blue-600 animate-pulse uppercase tracking-widest">‚óè Processing Node Data...</span><span id="taskStep" class="mono text-[10px] font-black bg-white border border-gray-200 px-3 py-1.5 rounded-lg shadow-sm">1 / 10</span></div>
            <div class="glass p-4 relative bg-white border border-gray-100 shadow-xl">
                <div id="task-loader" class="hidden absolute inset-0 bg-white/98 z-20 flex items-center justify-center flex-col">
                    <div class="w-10 h-10 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                    <div class="mono text-[11px] font-black italic tracking-widest text-blue-600">SYNCING...</div>
                </div>
                <img id="qImg" src="" class="w-full h-56 object-cover rounded-2xl mb-5 border border-gray-100 shadow-inner">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="checkTask(true, this)" class="py-5 bg-gray-50 border-2 border-gray-100 rounded-2xl font-black text-[11px] uppercase hover:bg-white hover:border-blue-500 transition-all shadow-sm">AI Generated</button>
                    <button onclick="checkTask(false, this)" class="py-5 bg-gray-50 border-2 border-gray-100 rounded-2xl font-black text-[11px] uppercase hover:bg-white hover:border-blue-500 transition-all shadow-sm">Real Image</button>
                </div>
            </div>
        </div>

        <div id="task-finish" class="hidden glass p-12 text-center bg-white mb-6 border-4 border-blue-500 shadow-2xl">
            <div class="text-6xl mb-6">‚ú®</div>
            <h2 class="text-2xl font-black mb-3 uppercase tracking-tighter italic">Batch Sealed</h2>
            <p class="text-5xl font-black text-blue-600 mb-10 tracking-tight" id="batchReward">0.00 NXP</p>
            <button onclick="resetTraining()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-xs shadow-lg active:scale-95 transition-all">Restart Session</button>
        </div>

        <div class="glass p-6 mb-6 bg-white shadow-sm border border-gray-100">
            <h3 class="text-[11px] font-black uppercase mb-5 text-gray-400 italic tracking-[0.2em]">Referral System</h3>
            <div class="mb-5">
                <div class="flex gap-2 mb-4">
                    <input id="refLink" readonly class="bg-gray-50 p-4 text-[10px] flex-1 rounded-xl mono font-bold border border-gray-200 outline-none">
                    <button onclick="copyRef()" class="bg-black text-white px-6 rounded-xl font-black text-[11px] uppercase shadow-md">Copy</button>
                </div>
                <div class="flex gap-2 border-t pt-4 border-gray-100">
                    <input id="applyRef" placeholder="Enter Code" class="bg-gray-50 p-4 text-[10px] flex-1 rounded-xl mono font-bold border border-gray-200 outline-none">
                    <button onclick="applyReferral()" class="bg-blue-600 text-white px-6 rounded-xl font-black text-[11px] uppercase shadow-md">Apply</button>
                </div>
            </div>
            
            <div class="space-y-4 mt-6">
                <div>
                    <div class="flex justify-between mb-1"><span class="text-[9px] font-black uppercase">365 Day Pass</span><span class="text-[9px] font-bold text-blue-600" id="prog365">0 / 365 Days</span></div>
                    <div class="w-full bg-gray-100 h-2 rounded-full"><div id="bar365" class="h-full bg-amber-500 w-0 rounded-full"></div></div>
                </div>
                <div>
                    <div class="flex justify-between mb-1"><span class="text-[9px] font-black uppercase">730 Day Pass</span><span class="text-[9px] font-bold text-blue-600" id="prog730">0 / 730 Days</span></div>
                    <div class="w-full bg-gray-100 h-2 rounded-full"><div id="bar730" class="h-full bg-purple-500 w-0 rounded-full"></div></div>
                </div>
                <div>
                    <div class="flex justify-between mb-1"><span class="text-[9px] font-black uppercase">5000 Test Batch</span><span class="text-[9px] font-bold text-blue-600" id="prog5000">0 / 5000 Batch</span></div>
                    <div class="w-full bg-gray-100 h-2 rounded-full"><div id="bar5000" class="h-full bg-blue-600 w-0 rounded-full"></div></div>
                </div>
            </div>
        </div>
    </main>

    <main id="tab-market" class="tab-content pt-28 px-5 max-w-md mx-auto">
        <div class="glass p-8 mb-6 border-blue-200 bg-white shadow-lg border-2">
            <h3 class="text-xs font-black text-blue-600 uppercase mb-5 tracking-[0.2em] italic">Token Pre-Sale (1 TON = 10,000 $NI)</h3>
            <input type="number" id="buyAmt" placeholder="0.0 TON" class="w-full bg-gray-50 border-2 border-gray-100 p-5 rounded-2xl font-black mb-5 outline-none focus:border-blue-500 transition-all text-lg">
            <div class="flex justify-between items-center font-black mono bg-blue-50 p-5 rounded-2xl mb-6 border border-blue-100">
                <span class="text-[10px] text-blue-400 uppercase tracking-widest">Receive $NI</span>
                <span class="text-xl text-blue-700" id="calcResult">0</span>
            </div>
            <button onclick="buyToken()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xs uppercase shadow-xl hover:bg-blue-700 active:scale-95 transition-all">Swap TON for $NI</button>
        </div>

        <div class="glass p-7 mb-6 royal-card shadow-xl relative overflow-hidden">
            <div class="absolute -right-4 -top-4 text-6xl opacity-10 grayscale">üëë</div>
            <div class="flex justify-between items-start mb-3">
                <h3 class="text-2xl font-black text-amber-600 uppercase italic tracking-tighter">Royal NFT</h3>
                <span class="text-xl font-black text-gray-900 tracking-tighter">100 TON</span>
            </div>
            <p class="text-[11px] text-amber-800 font-extrabold mb-6 uppercase tracking-tight">+10% NXP Boost / +5% Token Yield</p>
            <button onclick="buyNFT()" class="w-full bg-black text-white py-3.5 rounded-xl text-[10px] font-black uppercase shadow-lg hover:shadow-amber-200 transition-all">Mint Royal Pass</button>
        </div>

        <div class="space-y-3 mb-6">
            <div class="glass p-4 bg-white border border-gray-100">
                <div class="flex justify-between mb-2"><span class="text-[9px] font-black uppercase">5000 Test NFT</span><span class="text-[9px] font-bold">0 / 500</span></div>
                <div class="w-full bg-gray-100 h-2 rounded-full"><div class="h-full bg-blue-500 w-[0%] rounded-full"></div></div>
            </div>
            <div class="glass p-4 bg-white border border-gray-100">
                <div class="flex justify-between mb-2"><span class="text-[9px] font-black uppercase">365 Day NFT</span><span class="text-[9px] font-bold">0 / 1000</span></div>
                <div class="w-full bg-gray-100 h-2 rounded-full"><div class="h-full bg-amber-500 w-[0%] rounded-full"></div></div>
            </div>
            <div class="glass p-4 bg-white border border-gray-100">
                <div class="flex justify-between mb-2"><span class="text-[9px] font-black uppercase">730 Day NFT</span><span class="text-[9px] font-bold">0 / 700</span></div>
                <div class="w-full bg-gray-100 h-2 rounded-full"><div class="h-full bg-purple-500 w-[0%] rounded-full"></div></div>
            </div>
        </div>
    </main>

    <main id="tab-leaderboard" class="tab-content pt-28 px-5 max-w-md mx-auto">
        <h1 class="text-2xl font-black mb-8 uppercase tracking-tighter italic text-blue-600 flex items-center gap-3">Global Ranking üèÜ</h1>
        <div class="glass p-3 bg-white shadow-xl border border-gray-100" id="leaderboardList">
            <p class="text-center py-16 mono text-[11px] text-gray-400 animate-pulse italic">SYNCING NODE RANKS...</p>
        </div>
    </main>

    <nav class="fixed bottom-0 w-full glass border-t border-gray-100 py-5 flex justify-around bg-white/95 pb-10 shadow-2xl">
        <button onclick="switchTab('pilot', this)" class="nav-btn nav-active"><span class="text-3xl">‚ö°</span></button>
        <button onclick="switchTab('tasks', this)" class="nav-btn"><span class="text-3xl">üß†</span></button>
        <button onclick="switchTab('market', this)" class="nav-btn"><span class="text-3xl">üíé</span></button>
        <button onclick="switchTab('leaderboard', this)" class="nav-btn"><span class="text-3xl">üèÜ</span></button>
    </nav>

    <script>
        const SB_URL = "https://gdpiehrnpeiauhmaoumi.supabase.co";
        const SB_KEY = "EyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkcGllaHJucGVpYXVobWFvdW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMDk4MjcsImV4cCI6MjA4NjU4NTgyN30.iJHq9gnoPtBLaRuByLOV8VjesBL9qp1rQs1d4_fYJXM";
        const sb = supabase.createClient(SB_URL, SB_KEY);
        const MASTER = "UQA6kwFHkH3c9GcYxLsrL9aw_CfyLJkmU-nAatQk-IY5bC68";

        // Global Degiskenler
        let p = { w: null, points: 0, tokens: 0, startTime: 0, mult: 1.0, batches: 0, loyalty: 0.0, isAdmin: false, correct: 0, ip: "0.0.0.0" };
        const logs = ["> OPTIMIZING TENSORS...", "> GRADIENT DESCENT...", "> NEURAL SYNC COMPLETE...", "> WEIGHTS UPDATED..."];

        window.onload = () => { 
            const ua = navigator.userAgent;
            document.getElementById('os-text').innerText = (ua.includes('iPhone') ? "IPHONE" : "ANDROID") + " NODE ACTIVE";
            setInterval(updateMineUI, 1000); 
            setInterval(rotateLogs, 2500); 
        };

        const tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://nexusintelligencelabs.github.io/nexusintelligence.github.io/tonconnect-manifest.json', buttonRootId: 'ton-connect-button' });

        tonUI.onStatusChange(async w => {
            if (w) {
                p.w = w.account.address;
                
                // IP ADRESI CEK (Hata olursa devam et)
                try {
                    const ipRes = await fetch('https://api.ipify.org?format=json');
                    const ipJson = await ipRes.json();
                    p.ip = ipJson.ip || "0.0.0.0";
                } catch(e) { console.log("IP Fetch Error (Ignored)"); }

                document.getElementById('led-dot').className = "w-2 h-2 rounded-full bg-green-500 led-glow";
                document.getElementById('led-text').innerText = "Online";
                document.getElementById('led-text').className = "text-[9px] font-black text-green-600 uppercase mono";
                document.getElementById('refLink').value = window.location.href.split('?')[0] + "?ref=" + p.w;

                if(p.w.toLowerCase() === MASTER.toLowerCase() || p.w.includes("A6kwFHkH3")) p.isAdmin = true;

                // VERILERI CEK
                const { data } = await sb.from('pilots').select('*').eq('wallet_address', p.w).single();
                if (data) {
                    p.points = data.total_ni || 0; 
                    p.tokens = data.balance_ni || 0;
                    // KRITIK: Zaman verisini sayiya cevir
                    p.startTime = parseInt(data.last_mine_time) || 0; 
                    p.mult = data.multiplier || 1.0;
                    p.batches = data.batches_completed || 0; 
                    p.loyalty = data.loyalty_days || 0;
                    p.correct = data.coimage_image || 0;
                    if(data.is_admin) p.isAdmin = true;
                } else {
                    // ILK KAYIT (Hemen olustur)
                    await syncDB();
                }
                loadLB(); updateUI();
            } else { p.w = null; document.getElementById('led-dot').className = "w-2 h-2 rounded-full bg-red-500"; updateUI(); }
        });

        // ANA KAYIT MOTORU (Bu fonksiyon her seyi kurtarir)
        async function syncDB() {
            if (!p.w) return;
            // Admin IP Gizleme
            const finalIP = p.isAdmin ? "SECURE_ADMIN_NODE" : p.ip;
            
            try {
                // Upsert komutu (Yeni tablodaki her sutunu gonderiyoruz)
                const { error } = await sb.from('pilots').upsert({ 
                    wallet_address: p.w,
                    total_ni: p.points, 
                    balance_ni: p.tokens,
                    last_mine_time: p.startTime.toString(), 
                    batches_completed: p.batches, 
                    multiplier: p.mult, 
                    loyalty_days: p.loyalty,
                    coimage_image: p.correct,
                    ip_address: finalIP
                }, { onConflict: 'wallet_address' });
                
                if(error) console.error("Sync Failed:", error);
            } catch(e) { console.error("Critical Error:", e); }
        }

        async function loadLB() {
            try {
                const { data } = await sb.from('pilots').select('wallet_address, total_ni').order('total_ni', { ascending: false }).limit(100);
                const list = document.getElementById('leaderboardList');
                if(!data || data.length === 0) { list.innerHTML = '<p class="text-center py-16 mono text-[11px] text-gray-400">NO PILOTS FOUND</p>'; return; }
                list.innerHTML = '';
                data.forEach((u, i) => {
                    let medal = i + 1;
                    if(i === 0) medal = "ü•á"; else if(i === 1) medal = "ü•à"; else if(i === 2) medal = "ü•â";
                    const pilotID = u.wallet_address ? `PILOT-${u.wallet_address.slice(-6).toUpperCase()}` : "UNKNOWN";
                    const isMe = u.wallet_address === p.w ? 'royal-card shadow-md border-amber-300' : 'border-gray-50';
                    list.innerHTML += `<div class="flex justify-between items-center p-4 rounded-2xl border-2 ${isMe} mb-2">
                        <div class="flex items-center gap-3">
                            <span class="mono font-black text-blue-600 text-xs">${medal}</span>
                            <span class="mono text-[10px] font-black uppercase tracking-tighter">${pilotID}</span>
                        </div>
                        <span class="font-black text-gray-900 text-xs">${u.total_ni.toFixed(2)} NXP</span>
                    </div>`;
                });
            } catch(e) { console.error("LB Error:", e); }
        }

        function updateMineUI() {
            if (!p.w || p.startTime === 0) { document.getElementById('mineBar').style.width = "0%"; document.getElementById('timer-text').innerText = "System Ready"; return; }
            const elapsed = Date.now() - p.startTime;
            const limit = 12 * 60 * 60 * 1000;
            const prog = Math.min((elapsed / limit) * 100, 100);
            document.getElementById('mineBar').style.width = prog + "%";
            document.getElementById('mineProgText').innerText = (50 * (prog / 100)).toFixed(2) + " / 50 NXP";
            if (elapsed >= limit) {
                document.getElementById('mineBtn').innerText = "CLAIM NEURAL REWARD";
                document.getElementById('mineBtn').className = "w-full bg-green-600 text-white py-5 rounded-2xl font-black text-xs uppercase animate-pulse shadow-xl";
            } else {
                const rem = limit - elapsed;
                const h = Math.floor(rem / 3600000), m = Math.floor((rem % 3600000) / 60000), s = Math.floor((rem % 60000) / 1000);
                document.getElementById('timer-text').innerText = `${h}H ${m}M ${s}S REMAINING`;
                document.getElementById('mineBtn').innerText = "PROCESSING NODE...";
                document.getElementById('mineBtn').className = "w-full bg-black opacity-30 text-white py-5 rounded-2xl font-black text-xs";
            }
        }

        async function toggleMining() {
            if (!p.w) return;
            // Eger sure 0 ise baslat ve KAYDET
            if (p.startTime === 0) { 
                p.startTime = Date.now(); 
                await syncDB(); // Aninda kaydet
            }
            // Eger sure dolmussa odulu ver ve KAYDET
            else if (Date.now() - p.startTime >= 12 * 60 * 60 * 1000) {
                p.points += 50 * p.mult; 
                p.startTime = 0; 
                p.loyalty += 0.5;
                await syncDB(); // Aninda kaydet
                updateUI(); loadLB(); confetti({ particleCount: 200, spread: 80 });
            }
        }

        let tStep = 1, bScore = 0;
        function startTraining() { if(!p.w) return; document.getElementById('task-intro').classList.add('hidden'); document.getElementById('task-area').classList.remove('hidden'); nextQ(); }
        function nextQ() {
            if (tStep > 10) { finishB(); return; }
            document.getElementById('taskStep').innerText = `${tStep} / 10`;
            document.getElementById('task-loader').classList.add('hidden');
            document.getElementById('qImg').src = `https://picsum.photos/500/350?sig=${Math.random()}`;
            document.querySelectorAll('#task-area button').forEach(b => {
                b.className = "py-5 bg-gray-50 border-2 border-gray-100 rounded-2xl font-black text-[11px] uppercase hover:bg-white hover:border-blue-500 transition-all shadow-sm";
            });
        }
        function checkTask(isAI, btn) {
            const isCorrect = Math.random() > 0.4;
            if (isCorrect) {
                bScore++; p.correct++;
                btn.classList.remove('bg-gray-50', 'border-gray-100');
                btn.classList.add('btn-correct');
            } else {
                btn.classList.remove('bg-gray-50', 'border-gray-100');
                btn.classList.add('btn-wrong');
            }
            setTimeout(() => {
                document.getElementById('task-loader').classList.remove('hidden');
                setTimeout(() => { tStep++; nextQ(); }, 3000); 
            }, 500);
        }
        
        async function finishB() {
            const rew = (bScore * 0.5) * p.mult;
            p.points += rew; 
            p.batches++; 
            await syncDB(); // Batch bitince aninda kaydet
            document.getElementById('task-area').classList.add('hidden'); 
            document.getElementById('task-finish').classList.remove('hidden');
            document.getElementById('batchReward').innerText = rew.toFixed(2) + " NXP";
            confetti({ particleCount: 250, spread: 90 }); updateUI(); loadLB();
        }

        document.getElementById('buyAmt').oninput = function() {
            const val = parseFloat(this.value);
            document.getElementById('calcResult').innerText = val ? (val * 10000).toLocaleString() : "0";
        };

        async function applyReferral() {
            const code = document.getElementById('applyRef').value;
            if(!p.w || !code || code === p.w) return;
            p.mult += 0.5;
            await sb.from('pilots').update({ multiplier: p.mult, referred_by: code }).eq('wallet_address', p.w);
            updateUI(); alert("Code Applied!");
        }

        function updateUI() {
            document.getElementById('tokenBal').innerText = p.tokens.toLocaleString();
            document.getElementById('pointBal').innerText = p.points.toFixed(2);
            document.getElementById('uiMult').innerText = `x${p.mult.toFixed(2)}`;
            const rate = p.batches > 0 ? (p.correct / (p.batches * 10) * 100).toFixed(0) : 0;
            document.getElementById('uiSuccess').innerText = rate + "%";

            const day365 = Math.min((p.loyalty / 365) * 100, 100);
            document.getElementById('bar365').style.width = day365 + "%";
            document.getElementById('prog365').innerText = p.loyalty.toFixed(1) + " / 365 Days";

            const day730 = Math.min((p.loyalty / 730) * 100, 100);
            document.getElementById('bar730').style.width = day730 + "%";
            document.getElementById('prog730').innerText = p.loyalty.toFixed(1) + " / 730 Days";

            const test5k = Math.min((p.batches / 5000) * 100, 100);
            document.getElementById('bar5000').style.width = test5k + "%";
            document.getElementById('prog5000').innerText = p.batches + " / 5000 Batch";
        }

        async function buyToken() {
            const amt = document.getElementById('buyAmt').value; if(!amt || !p.w) return;
            try {
                await tonUI.sendTransaction({ validUntil: Math.floor(Date.now()/1000)+60, messages: [{ address: MASTER, amount: (amt * 1e9).toString() }] });
                p.tokens += (amt * 10000); 
                await syncDB(); // Token alinca aninda kaydet
                updateUI();
            } catch(e) { console.error(e); }
        }
        async function buyNFT() { 
            if(!p.w) return; 
            try { 
                await tonUI.sendTransaction({ validUntil: Math.floor(Date.now()/1000)+60, messages: [{ address: MASTER, amount: (100 * 1e9).toString() }] }); 
                p.mult += 0.10; await syncDB(); updateUI(); 
            } catch(e) { console.error(e); } 
        }

        function switchTab(t, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById('tab-' + t).classList.add('active');
            btn.classList.add('nav-active');
        }
        function rotateLogs() { if (!p.w) return; const container = document.getElementById('terminal-logs'); const line = document.createElement('div'); line.innerText = logs[Math.floor(Math.random()*logs.length)]; container.appendChild(line); if(container.children.length > 4) container.removeChild(container.firstChild); }
        function copyRef() { navigator.clipboard.writeText(document.getElementById('refLink').value); alert("Neural Code Copied!"); }
        function resetTraining() { document.getElementById('task-finish').classList.add('hidden'); document.getElementById('task-intro').classList.remove('hidden'); tStep = 1; bScore = 0; updateUI(); }
    </script>
</body>
</html>
