<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Intelligence | Neural Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #050505; color: white; overflow-x: hidden; }
        .mono-font { font-family: 'Share Tech Mono', monospace; }
        .glass-panel { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; }
        .tab-content { display: none; }
        .tab-content.active { display: block !important; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* MATRIX BACKGROUND EFFECT */
        .matrix-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            overflow: hidden;
        }
        .code-rain {
            position: absolute; top: -100%; color: #0071e3; font-family: 'Share Tech Mono', monospace;
            font-size: 10px; opacity: 0.3; writing-mode: vertical-rl; text-orientation: upright;
            animation: rain 10s linear infinite;
        }
        @keyframes rain { 0% { top: -100%; } 100% { top: 100%; } }

        .nav-btn { opacity: 0.5; transition: 0.3s; }
        .nav-active { opacity: 1; color: #0071e3; transform: scale(1.1); }
        .correct-btn { background: #10b981 !important; color: black !important; border: none !important; }
        .wrong-btn { background: #ef4444 !important; color: white !important; border: none !important; }
        #ton-connect-button { min-width: 140px; }
    </style>
</head>
<body class="pb-32">

    <div class="matrix-bg" id="matrixContainer">
        </div>

    <nav class="fixed top-0 w-full z-50 glass-panel border-b border-white/5 px-6 py-4 flex justify-between items-center rounded-none">
        <div class="flex flex-col">
            <span class="text-xl font-black italic tracking-widest text-white">NEXUS <span class="text-blue-500">INTEL</span></span>
            <span id="device-info" class="text-[9px] font-bold text-gray-500 uppercase tracking-widest mono-font">SYSTEM BOOTING...</span>
        </div>
        <div id="ton-connect-button"></div>
    </nav>

    <main id="tab-pilot" class="tab-content active pt-28 px-6 max-w-md mx-auto">
        <div class="glass-panel p-8 mb-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"></div>
            <p class="text-[10px] text-gray-400 font-bold mb-2 uppercase tracking-widest">Total Confirmed Balance</p>
            <h2 class="text-5xl font-black text-white tracking-tighter mb-8 flex justify-center items-center gap-2">
                <span class="text-blue-500 text-3xl">‚óà</span> <span id="mainBal">0.00</span>
            </h2>
            
            <div class="bg-white/5 rounded-2xl p-6 border border-white/10">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase mono-font">MINING BUFFER (SAVE)</span>
                    <span class="text-xs font-bold text-blue-400 mono-font" id="poolTxt">0.00 / 50.00</span>
                </div>
                <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden mb-4">
                    <div id="poolBar" class="h-full bg-blue-600 w-0 transition-all duration-500 shadow-[0_0_15px_#2563eb]"></div>
                </div>
                <button id="claimBtn" disabled onclick="claimTokens()" class="w-full py-3 rounded-xl font-bold text-[10px] bg-white/10 text-gray-500 uppercase tracking-widest hover:bg-blue-600 hover:text-white transition-all">SEAL TO WALLET (MIN 50)</button>
            </div>
        </div>

        <button onclick="toggleMining()" id="mineBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-6 rounded-2xl font-black text-lg shadow-[0_0_30px_rgba(37,99,235,0.3)] mb-8 active:scale-95 transition-all flex justify-center items-center gap-3 border border-white/10">
            <span class="animate-pulse">‚ö°</span> <span id="mineText">INITIALIZE VERA ENGINE</span>
        </button>

        <div class="grid grid-cols-2 gap-4">
            <div class="glass-panel p-4 text-center">
                <p class="text-[9px] text-gray-500 font-bold uppercase mb-1">Node Speed</p>
                <p class="text-xl font-black text-blue-400 mono-font" id="uiMult">x1.00</p>
            </div>
            <div class="glass-panel p-4 text-center">
                <p class="text-[9px] text-gray-500 font-bold uppercase mb-1">Valid Data</p>
                <p class="text-xl font-black text-white mono-font" id="uiCor">0</p>
            </div>
        </div>
    </main>

    <main id="tab-tasks" class="tab-content pt-28 px-6 max-w-md mx-auto">
        <div id="task-intro" class="glass-panel p-10 text-center">
            <div class="w-16 h-16 border-2 border-blue-500 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-[0_0_20px_rgba(37,99,235,0.4)]">üëÅÔ∏è</div>
            <h2 class="text-2xl font-black mb-4 uppercase tracking-tight text-white">Neural Training</h2>
            <p class="text-gray-400 text-xs mb-8 leading-relaxed font-mono">Complete a batch of 10 images. Rewards are calculated at the end of the session based on accuracy.</p>
            <button onclick="startTraining()" class="w-full bg-white text-black py-4 rounded-xl font-black shadow-lg uppercase tracking-widest hover:bg-gray-200">START BATCH</button>
        </div>

        <div id="task-area" class="hidden">
            <div class="flex justify-between items-center mb-4 px-2">
                <span class="text-[10px] font-bold text-blue-500 uppercase animate-pulse">‚óè LIVE FEED</span>
                <span id="taskStep" class="text-xs font-bold bg-white/10 px-3 py-1 rounded text-white mono-font">1 / 10</span>
            </div>
            <div class="glass-panel p-4 relative overflow-hidden">
                <div id="task-loader" class="hidden absolute inset-0 bg-black/90 z-20 flex items-center justify-center flex-col">
                    <div class="text-blue-500 font-mono text-xs mb-2">UPLOADING NEURAL DATA...</div>
                    <div class="w-32 h-1 bg-gray-800 rounded overflow-hidden">
                        <div class="h-full bg-blue-500 animate-[width_5s_linear_forwards]" style="width:0%"></div>
                    </div>
                </div>
                
                <img id="qImg" src="https://picsum.photos/400/300" class="w-full h-64 object-cover rounded-xl mb-6 border border-white/10">
                <div class="grid grid-cols-2 gap-4">
                    <button id="btnAI" onclick="checkTask(true, this)" class="py-4 bg-white/5 border border-white/10 rounded-xl font-bold text-[10px] text-white uppercase hover:bg-white/10">AI GENERATED</button>
                    <button id="btnReal" onclick="checkTask(false, this)" class="py-4 bg-white/5 border border-white/10 rounded-xl font-bold text-[10px] text-white uppercase hover:bg-white/10">REAL PHOTO</button>
                </div>
            </div>
        </div>

        <div id="task-finish" class="hidden glass-panel p-10 text-center">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 class="text-2xl font-black mb-2 text-white">BATCH COMPLETE</h2>
            <p class="text-gray-400 text-xs mb-6 mono-font">Analysis: <span id="batchResult" class="text-blue-400">0</span> Correct</p>
            <div class="bg-blue-600/20 p-4 rounded-xl border border-blue-500/30 mb-6">
                <p class="text-[10px] text-blue-300 uppercase">Reward Earned</p>
                <p class="text-2xl font-black text-white" id="batchReward">0.00 $NI</p>
            </div>
            <button onclick="resetTraining()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase">CLAIM & RETURN</button>
        </div>
    </main>

    <main id="tab-market" class="tab-content pt-28 px-6 max-w-md mx-auto">
        <div class="glass-panel p-6 mb-6">
            <h3 class="text-xs font-bold text-blue-400 mb-4 uppercase tracking-widest border-b border-white/10 pb-2">Quantum Calculator</h3>
            <input type="number" id="buyAmt" placeholder="Enter TON Amount (e.g. 0.5)" class="w-full bg-black/50 border border-white/20 p-4 rounded-xl outline-none font-bold text-white mb-4 mono-font focus:border-blue-500 transition-colors">
            <div class="flex justify-between items-center bg-blue-900/20 p-4 rounded-xl border border-blue-500/20 mb-4">
                <span class="text-[10px] text-blue-300 uppercase">You Receive:</span>
                <span class="text-xl font-black text-white mono-font" id="calcResult">0 $NI</span>
            </div>
            <button onclick="buyToken()" class="w-full bg-white text-black py-4 rounded-xl font-black uppercase text-xs hover:bg-gray-200">PURCHASE TOKENS</button>
        </div>

        <div class="glass-panel p-1 mb-6 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 border-yellow-500/30">
            <div class="bg-black/80 p-6 rounded-[20px]">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-black text-white italic">ELITE NODE NFT</h3>
                    <span class="bg-yellow-500 text-black text-[9px] px-2 py-1 rounded font-bold uppercase">Legendary</span>
                </div>
                <p class="text-[10px] text-gray-400 mb-6 leading-relaxed"> Owning this NFT designates you as a Priority Node. Grants permanent <span class="text-white font-bold">x1.50 Speed Boost</span> and Airdrop whitelisting.</p>
                <button onclick="buyNFT()" class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg">MINT FOR 100 TON</button>
            </div>
        </div>
        
        <div class="glass-panel p-6">
             <p class="text-[10px] font-bold text-gray-500 uppercase mb-3">Node Referral Link</p>
             <div class="flex gap-2">
                 <input id="refLink" readonly value="Connect Wallet..." class="bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-[10px] flex-1 outline-none text-gray-400 mono-font">
                 <button onclick="copyRef()" class="bg-white/10 text-white font-bold px-4 rounded-lg text-[10px] hover:bg-white/20">COPY</button>
             </div>
        </div>
    </main>

    <main id="tab-whitepaper" class="tab-content pt-28 px-6 max-w-md mx-auto pb-10">
        <h1 class="text-3xl font-black text-white mb-6 tracking-tighter uppercase italic">The Nexus Protocol</h1>
        <div class="glass-panel p-8 space-y-8 text-xs text-gray-400 leading-relaxed font-mono">
            <div class="border-l-2 border-blue-500 pl-4">
                <strong class="text-white block mb-1 uppercase">NexusintelligenceTeam</strong>
                We are architects of the decentralized AI future.
            </div>
            <div>
                <strong class="text-white block mb-1 uppercase">The Vera Engine</strong>
                A distributed supercomputer powered by millions of mobile nodes. Your device validates visual data to train our core Neural Network.
            </div>
            <div>
                <strong class="text-white block mb-1 uppercase">$NI Tokenomics</strong>
                Rate: 1 TON = 10,000 $NI.<br>Used for: Governance, Compute Power, NFT Minting.
            </div>
        </div>
    </main>

    <div class="fixed bottom-0 w-full glass-panel border-t border-white/5 flex justify-around py-6 z-50 rounded-none bg-black/90">
        <button onclick="switchTab('pilot', this)" class="nav-btn nav-active flex flex-col items-center gap-1"><span class="text-xl">üöÄ</span></button>
        <button onclick="switchTab('tasks', this)" class="nav-btn flex flex-col items-center gap-1"><span class="text-xl">üß†</span></button>
        <button onclick="switchTab('market', this)" class="nav-btn flex flex-col items-center gap-1"><span class="text-xl">üíé</span></button>
        <button onclick="switchTab('whitepaper', this)" class="nav-btn flex flex-col items-center gap-1"><span class="text-xl">üìÑ</span></button>
    </div>

    <script>
        // CONFIG
        const SB_URL = "https://gdpiehrnpeiauhmaoumi.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkcGllaHJucGVpYXVobWFvdW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMDk4MjcsImV4cCI6MjA4NjU4NTgyN30.iJHq9gnoPtBLaRuByLOV8VjesBL9qp1rQs1d4_fYJXM";
        const sb = supabase.createClient(SB_URL, SB_KEY);
        const ADMIN_WALLET = "UQA6kwFHkH3c9GcYxLsrL9aw_CfyLJkmU-nAatQk-IY5bC68";

        let p = { w: null, main: 0, pool: 0, mult: 1.0, cor: 0, ip: "0.0.0.0" };
        let mineTimer = null;
        
        // Task Variables
        let tStep = 1;
        let cAns = true;
        let batchScore = 0; // Temp score for the batch

        // üì± INITIALIZATION & MATRIX RAIN
        window.onload = async () => {
            const ua = navigator.userAgent;
            const dev = /iPhone|iPad|iPod/.test(ua) ? "IPHONE NODE" : /Android/.test(ua) ? "ANDROID NODE" : "WEB CONSOLE";
            document.getElementById('device-info').innerText = dev + " | CONNECTED";
            
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                p.ip = data.ip;
            } catch(e) {}
            
            initMatrix();
        };

        function initMatrix() {
            const container = document.getElementById('matrixContainer');
            for(let i=0; i<10; i++) {
                let d = document.createElement('div');
                d.className = 'code-rain';
                d.style.left = Math.random()*100 + '%';
                d.style.animationDuration = (Math.random()*5 + 5) + 's';
                d.innerText = '01101001 01101110 01110100 01100101 01101100 00100000 01100100 01100001 01110100 01100001';
                container.appendChild(d);
            }
        }

        // TABS
        function switchTab(t, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById('tab-' + t).classList.add('active');
            btn.classList.add('nav-active');
        }

        // WALLET & DATA LOADING (PERSISTENCE FIX)
        const tonUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://nexusintelligencelabs.github.io/nexusintelligence.github.io/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        tonUI.onStatusChange(async w => {
            if (w) { 
                p.w = w.account.address; 
                document.getElementById('refLink').value = window.location.origin + "/?ref=" + p.w;
                
                // LOAD DATA FROM DB (INCLUDING SAVED POOL)
                const { data } = await sb.from('pilots').select('*').eq('wallet_address', p.w).single();
                if (data) {
                    p.main = data.total_ni; 
                    p.mult = data.multiplier; 
                    p.cor = data.correct_images;
                    p.pool = data.mining_pool || 0; // RECALL SAVED POOL
                    updateUI();
                }
            } else {
                // RESET IF DISCONNECTED
                p = { w: null, main: 0, pool: 0, mult: 1.0, cor: 0, ip: p.ip };
                updateUI();
            }
        });

        // UI UPDATE
        function updateUI() {
            document.getElementById('mainBal').innerText = p.main.toFixed(2);
            document.getElementById('poolTxt').innerText = `${p.pool.toFixed(2)} / 50.00`;
            document.getElementById('uiMult').innerText = `x${p.mult.toFixed(2)}`;
            document.getElementById('uiCor').innerText = p.cor;
            
            let prog = (p.pool / 50) * 100;
            document.getElementById('poolBar').style.width = Math.min(prog, 100) + "%";
            
            if (p.pool >= 50) {
                const c = document.getElementById('claimBtn');
                c.disabled = false; c.classList.replace('bg-white/10', 'bg-blue-600'); c.classList.replace('text-gray-500', 'text-white');
            }
        }

        // MINING (AUTO SAVE EVERY 5 SECONDS)
        function toggleMining() {
            const b = document.getElementById('mineBtn');
            const txt = document.getElementById('mineText');
            if (!mineTimer) {
                txt.innerText = "VERA ENGINE ACTIVE"; b.classList.replace('bg-blue-600', 'bg-red-600');
                // Create more matrix rain
                initMatrix(); 
                
                mineTimer = setInterval(() => { 
                    p.pool += (0.01 * p.mult); 
                    updateUI(); 
                    if(Math.floor(p.pool*100)%500 === 0) save(); // Auto-save occasionally
                }, 1000);
            } else {
                txt.innerText = "INITIALIZE VERA ENGINE"; b.classList.replace('bg-red-600', 'bg-blue-600');
                clearInterval(mineTimer); mineTimer = null;
                save(); // Save on stop
            }
        }

        async function claimTokens() {
            if (p.pool < 50) return;
            p.main += p.pool; 
            p.pool = 0; 
            updateUI(); 
            save(); // Save immediately
            alert("Funds Secured on Blockchain.");
        }

        async function save() {
            if (!p.w) return;
            // SAVES POOL TO DB SO IT PERSISTS ON RELOAD
            await sb.from('pilots').upsert({ 
                wallet_address: p.w, 
                total_ni: p.main, 
                correct_images: p.cor, 
                multiplier: p.mult,
                ip_address: p.ip,
                mining_pool: p.pool // KEY FIX
            });
        }

        // TRAINING (BATCH LOGIC + 5S DELAY)
        function startTraining() {
            document.getElementById('task-intro').classList.add('hidden');
            document.getElementById('task-area').classList.remove('hidden');
            tStep = 1; batchScore = 0; nextQ();
        }

        function nextQ() {
            if (tStep > 10) { finishBatch(); return; }
            document.getElementById('taskStep').innerText = `${tStep} / 10`;
            document.getElementById('task-loader').classList.add('hidden');
            cAns = Math.random() > 0.5;
            document.getElementById('qImg').src = `https://picsum.photos/400/300?sig=${Math.random()}`;
            
            // Reset buttons
            ['btnAI', 'btnReal'].forEach(id => {
                let btn = document.getElementById(id);
                btn.disabled = false;
                btn.className = "py-4 bg-white/5 border border-white/10 rounded-xl font-bold text-[10px] text-white uppercase hover:bg-white/10";
            });
        }

        function checkTask(val, btn) {
            document.getElementById('btnAI').disabled = true;
            document.getElementById('btnReal').disabled = true;

            if (val === cAns) {
                batchScore++; // Increment temp score
                btn.classList.add('correct-btn');
            } else {
                btn.classList.add('wrong-btn');
            }

            // 5 SECOND DELAY
            document.getElementById('task-loader').classList.remove('hidden');
            setTimeout(() => {
                tStep++; nextQ();
            }, 5000);
        }

        function finishBatch() {
            document.getElementById('task-area').classList.add('hidden');
            document.getElementById('task-finish').classList.remove('hidden');
            
            // CALCULATE TOTAL REWARD (0.5 per correct)
            const reward = batchScore * 0.5;
            document.getElementById('batchResult').innerText = batchScore;
            document.getElementById('batchReward').innerText = reward.toFixed(2) + " $NI";
            
            // COMMIT TO MAIN BALANCE
            p.main += reward;
            p.cor += batchScore;
            
            confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 }, colors: ['#0071e3', '#ffffff'] });
            save();
        }

        function resetTraining() {
            document.getElementById('task-finish').classList.add('hidden');
            document.getElementById('task-intro').classList.remove('hidden');
            updateUI();
        }

        // MARKET CALCULATOR & BUY
        document.getElementById('buyAmt').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value) || 0;
            document.getElementById('calcResult').innerText = `‚âà ${(val * 10000).toLocaleString()} $NI`;
        });

        async function buyToken() {
            const a = document.getElementById('buyAmt').value;
            if(!a || a <= 0 || !p.w) return alert("Wallet or Amount Error.");
            try {
                await tonUI.sendTransaction({
                    validUntil: Math.floor(Date.now()/1000)+60,
                    messages: [{ address: ADMIN_WALLET, amount: (a * 1000000000).toString() }]
                });
                await sb.from('orders').insert({ 
                    wallet_address: p.w, item_type: 'COIN', amount_ton: parseFloat(a), received_ni: a * 10000 
                });
                alert("Tokens Secured."); loadData();
            } catch(e) { alert("Cancelled."); }
        }

        async function buyNFT() {
            if(!p.w) return alert("Connect Wallet First.");
            try {
                await tonUI.sendTransaction({
                    validUntil: Math.floor(Date.now()/1000)+60,
                    messages: [{ address: ADMIN_WALLET, amount: (100 * 1000000000).toString() }]
                });
                // Update Multiplier
                p.mult = 1.5;
                await sb.from('pilots').update({ multiplier: 1.5 }).eq('wallet_address', p.w);
                await sb.from('orders').insert({ 
                    wallet_address: p.w, item_type: 'NFT', amount_ton: 100, received_ni: 0 
                });
                alert("Elite NFT Acquired! Speed Boost Active.");
                updateUI();
            } catch(e) { alert("Cancelled."); }
        }
        
        function copyRef() {
            navigator.clipboard.writeText(document.getElementById("refLink").value);
            alert("Link Copied.");
        }
    </script>
</body>
</html>
